<!DOCTYPE html>
<html lang="es">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador PDF - Invitación Final (QR ID)</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: 'Georgia', serif; background: #eef2f3; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 420px; text-align: center; }
        h2 { color: #926F34; margin-top: 0; font-style: italic; }
        
        .info-evento { background: #f9f9f9; padding: 10px; border-radius: 6px; margin-bottom: 20px; border: 1px dashed #ccc; font-size: 0.85em; color: #555; text-align: left;}
        input { width: 100%; margin: 8px 0; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: 'Georgia', serif; }
        button { width: 100%; padding: 15px; background: #926F34; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 15px; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; transition: background 0.3s;}
        button:hover { background: #7a5d2b; }
        
        /* Ocultamos los canvas de trabajo */
        #canvasInvitacion, #canvasPase, #qrcode-temp { display: none; }
    </style>
</head>
<body>

<div class="card">
    <h2>Datos del Invitado</h2>
    <div class="info-evento" id="resumenDatos">Cargando datos del evento...</div>
    
    <input type="text" id="familia" placeholder="Apellidos (Ej. Pérez López)">
    <input type="text" id="mesa" placeholder="Número de Mesa">
    <input type="number" id="invitaciones" placeholder="Cantidad de Personas">
    
    <button id="btnDescargar" onclick="generarPDF()">Descargar Invitación + Pase</button>
</div>

<div id="qrcode-temp"></div>
<canvas id="canvasInvitacion"></canvas> 
<canvas id="canvasPase"></canvas>

<script>
    // =========================================================
    // 1. CONFIGURACIÓN DE SUPABASE
    // =========================================================
    const SUPABASE_URL = 'https://iqwkaorhtksudfspupzo.supabase.co/';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlxd2thb3JodGtzdWRmc3B1cHpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMTQzNTUsImV4cCI6MjA4NDY5MDM1NX0.7vgdhkqHSFUDv6WrFE_5E40YfEh6CmGHovLOYkJ2sNw';
     
    const { createClient } = supabase;
    const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // =========================================================
    // 2. LÓGICA DEL PROGRAMA
    // =========================================================
    let datosEvento = { nombre: "", diaNombre: "", diaNumero: "", mes: "", hora: "" };

    window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        // El slug de la boda viene del parámetro 'evento' en la URL
        datosEvento.nombre = decodeURIComponent(params.get('evento') || "Boda");
        datosEvento.diaNombre = decodeURIComponent(params.get('diaNombre') || "SÁBADO");
        datosEvento.diaNumero = decodeURIComponent(params.get('diaNumero') || "24");
        datosEvento.mes = decodeURIComponent(params.get('mes') || "OCTUBRE");
        datosEvento.hora = decodeURIComponent(params.get('hora') || "6:00 PM");

        document.getElementById('resumenDatos').innerHTML = `
            <strong>Evento (boda_slug):</strong> ${datosEvento.nombre}<br>
            <strong>Fecha:</strong> ${datosEvento.diaNombre} ${datosEvento.diaNumero} de ${datosEvento.mes}<br>
            <strong>Hora:</strong> ${datosEvento.hora}
        `;
    };

    function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
        let words = text.split(' '); let line = ''; let lines = [];
        for(let n = 0; n < words.length; n++) {
            let testLine = line + words[n] + ' ';
            let metrics = ctx.measureText(testLine);
            if (metrics.width > maxWidth && n > 0) { lines.push(line); line = words[n] + ' '; }
            else { line = testLine; }
        }
        lines.push(line);
        let startY = y;
        if (lines.length > 1) { startY = y - ((lines.length - 1) * lineHeight) / 2; }
        for(let k = 0; k < lines.length; k++) { ctx.fillText(lines[k], x, startY + (k * lineHeight)); }
    }

    // --- FUNCIÓN GUARDAR EN BD CORREGIDA ---
    async function guardarInvitadoBD(familia, mesa, numInvitados, idAleatorio) {
        try {
            const { data, error } = await _supabase
                .from('invitados') 
                .insert([{ 
                        id_invitado_firebase: idAleatorio,
                        boda_slug: datosEvento.nombre,
                        fam_nombre: familia,
                        num_invitados: parseInt(numInvitados),
                        num_mesa: parseInt(mesa),
                        estado: 'sin llegar',
                        num_invitados_confirmados: 0,
                        invitados_llegados: 0,
                        confirmado: 0 
                }])
                .select();

            if (error) {
                console.error("Error BD:", error);
                if (error.code === '23503') { 
                    alert(`Error: El evento "${datosEvento.nombre}" no existe en la tabla de Bodas.`);
                } else {
                    alert("Error guardando en BD: " + error.message);
                }
                return false;
            }
            return true;
        } catch (err) {
            console.error(err);
            alert("Error de conexión con la base de datos.");
            return false;
        }
    }

    async function generarPDF() {
        if (!window.jspdf) return alert("Error de librerías.");
        const { jsPDF } = window.jspdf;
        
        const inputFamilia = document.getElementById('familia').value;
        const mesa = document.getElementById('mesa').value || "0";
        const invitaciones = document.getElementById('invitaciones').value || "1";
        const btn = document.getElementById('btnDescargar');

        if(!inputFamilia) return alert("Escribe el nombre de la familia.");

        btn.disabled = true;
        btn.innerText = "Procesando...";

        // Generamos ID único (UUID)
        const idAleatorio = crypto.randomUUID();

        // 1. Guardar en Base de Datos
        const guardadoExitoso = await guardarInvitadoBD(inputFamilia, mesa, invitaciones, idAleatorio);
        
        if (!guardadoExitoso) {
            btn.disabled = false;
            btn.innerText = "Descargar Invitación + Pase";
            return; 
        }

        let nombreFamiliaFinal = inputFamilia.trim();
        if (!nombreFamiliaFinal.toUpperCase().startsWith("FAM")) {
            nombreFamiliaFinal = "FAM. " + nombreFamiliaFinal.toUpperCase();
        } else {
            nombreFamiliaFinal = nombreFamiliaFinal.toUpperCase();
        }

        const img = new Image();
        img.src = 'Fondo.jpg'; 

        img.onload = function() {
            // PÁGINA 1: INVITACIÓN
            const cv1 = document.getElementById('canvasInvitacion');
            const ctx1 = cv1.getContext('2d');
            cv1.width = img.width; cv1.height = img.height;
            ctx1.drawImage(img, 0, 0); 
            
            ctx1.fillStyle = "#926F34"; ctx1.textAlign = "center";
            ctx1.font = "italic " + (cv1.height * 0.04) + "px Georgia, serif"; 
            ctx1.fillText("NOS CASAMOS", cv1.width / 2, cv1.height * 0.28);
            
            ctx1.font = "italic " + (cv1.height * 0.05) + "px Georgia, serif"; 
            ctx1.fillText("Ruby & Pablo", cv1.width / 2, cv1.height * 0.35);
            
            ctx1.font = (cv1.height * 0.025) + "px Arial"; 
            ctx1.fillText("INVITACIÓN PARA:", cv1.width / 2, cv1.height * 0.43);
            
            let fontFamilia = cv1.height * 0.055; 
            ctx1.font = "bold " + fontFamilia + "px Georgia, serif";
            wrapText(ctx1, nombreFamiliaFinal, cv1.width / 2, cv1.height * 0.52, cv1.width * 0.8, fontFamilia * 1.2);
            
            ctx1.font = (cv1.height * 0.035) + "px Georgia, serif"; 
            ctx1.fillText("PERSONAS: " + invitaciones, cv1.width / 2, cv1.height * 0.62);
            
            let yFecha = cv1.height * 0.72; let cx = cv1.width / 2; 
            ctx1.font = (cv1.height * 0.025) + "px Arial"; ctx1.textAlign = "right"; 
            ctx1.fillText(datosEvento.diaNombre.toUpperCase(), cx - (cv1.width * 0.12), yFecha);
            
            ctx1.font = "italic bold " + (cv1.height * 0.075) + "px Georgia, serif"; ctx1.textAlign = "center"; 
            ctx1.fillText(datosEvento.diaNumero, cx, yFecha);
            
            ctx1.font = (cv1.height * 0.025) + "px Arial"; ctx1.textAlign = "left"; 
            ctx1.fillText(datosEvento.mes.toUpperCase(), cx + (cv1.width * 0.12), yFecha);
            
            ctx1.beginPath(); ctx1.lineWidth = 2; ctx1.strokeStyle = "#926F34"; 
            let lineH = cv1.height * 0.04;
            ctx1.moveTo(cx - (cv1.width * 0.08), yFecha - lineH); ctx1.lineTo(cx - (cv1.width * 0.08), yFecha + 5);
            ctx1.moveTo(cx + (cv1.width * 0.08), yFecha - lineH); ctx1.lineTo(cx + (cv1.width * 0.08), yFecha + 5); ctx1.stroke();
            
            ctx1.textAlign = "center"; ctx1.font = "bold " + (cv1.height * 0.025) + "px Arial"; 
            ctx1.fillText("HORA: " + datosEvento.hora, cv1.width / 2, cv1.height * 0.78);
            ctx1.font = (cv1.height * 0.035) + "px Arial"; 
            ctx1.fillText("MESA: " + mesa, cv1.width / 2, cv1.height * 0.83);

            // PÁGINA 2: PASE DIGITAL
            const cv2 = document.getElementById('canvasPase');
            const ctx2 = cv2.getContext('2d');
            cv2.width = img.width; cv2.height = img.height;
            ctx2.drawImage(img, 0, 0); 
            
            const margin = 0.05; 
            const boxX = cv2.width * margin; const boxY = cv2.height * margin;
            const boxW = cv2.width * (1 - (margin * 2)); const boxH = cv2.height * 0.82; 
            
            ctx2.fillStyle = "#ffffff"; ctx2.fillRect(boxX, boxY, boxW, boxH);
            ctx2.strokeStyle = "#926F34"; ctx2.lineWidth = 5; ctx2.strokeRect(boxX, boxY, boxW, boxH);

            ctx2.fillStyle = "#926F34"; ctx2.textAlign = "center";
            ctx2.font = "bold " + (cv2.height * 0.035) + "px Arial"; 
            ctx2.fillText("ESTE ES TU PASE DIGITAL", cv2.width / 2, cv2.height * 0.20);
            
            // GENERAR QR
            const qrContainer = document.getElementById("qrcode-temp");
            qrContainer.innerHTML = "";
            new QRCode(qrContainer, {
                text: idAleatorio, 
                width: 512, height: 512, 
                colorDark : "#926F34", colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            setTimeout(() => {
                const qrImg = qrContainer.querySelector('img') || qrContainer.querySelector('canvas');
                if(qrImg) {
                    const qrSize = cv2.width * 0.60; 
                    const qrX = (cv2.width - qrSize) / 2;
                    const qrY = cv2.height * 0.23; 
                    ctx2.drawImage(qrImg, qrX, qrY, qrSize, qrSize);

                    const yTextoPersonas = qrY + qrSize + (cv2.height * 0.05);
                    ctx2.font = "bold " + (cv2.height * 0.030) + "px Arial";
                    ctx2.fillText(`ACCESO: ${invitaciones} PERSONAS`, cv2.width / 2, yTextoPersonas);
                }

                try {
                    const doc = new jsPDF({ orientation: cv1.width > cv1.height ? 'l' : 'p', unit: 'px', format: [cv1.width, cv1.height] });
                    doc.addImage(cv1.toDataURL("image/jpeg", 0.90), 'JPEG', 0, 0, cv1.width, cv1.height);
                    doc.addPage([cv1.width, cv1.height]); 
                    doc.addImage(cv2.toDataURL("image/jpeg", 0.90), 'JPEG', 0, 0, cv2.width, cv2.height);
                    doc.save(`Invitacion_${inputFamilia}.pdf`);
                    
                    btn.disabled = false;
                    btn.innerText = "Descargar Invitación + Pase";
                } catch (e) { 
                    alert("Error al generar PDF. Asegúrate de usar un servidor local (Live Server)."); 
                    btn.disabled = false;
                    btn.innerText = "Descargar Invitación + Pase";
                }
            }, 500);
        };
        img.onerror = function() { alert("No se pudo cargar Fondo.jpg. Verifica que el archivo esté en la misma carpeta."); };
    }
</script>

</body>
</html>
